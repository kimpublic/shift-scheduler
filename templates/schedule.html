{{define "title"}}Schedule â€“ Shift Scheduler{{end}}

{{define "content"}}
<style>
  /* ë ˆì´ì•„ì›ƒ */
  .page {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.5rem;
  }
  .card {
    background: #fff;
    border: 1px solid #e7e7e7;
    border-radius: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,.04);
  }
  .card .body { padding: 1rem 1.25rem; }

  /* ìƒíƒœ ë°°ë„ˆ (ì´ˆê¸°: draft) */
  .status-banner {
    margin-bottom: 1rem;
    padding: .75rem 1rem;
    border-radius: 8px;
    background: #eef5ff;
    color: #002E5D;
    font-weight: 600;
  }

  /* ìƒíƒœë³„ ë°°ë„ˆ ìƒ‰ìƒ (data-status ê¸°ë°˜) */
  .status-banner[data-status="Draft"]    { background:#eef5ff; color:#002E5D; }
  .status-banner[data-status="Pending"]  { background:#fff7e0; color:#7a4b00; }
  .status-banner[data-status="Approved"] { background:#e7f7ec; color:#0b5f2a; }
  .status-banner[data-status="Rejected"] { background:#fdecec; color:#8a0000; }

  /* ì‹œê°„ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ */
  .week {
    padding: 1rem 1.25rem 1.5rem;
  }
  .week .header {
    display: grid;
    grid-template-columns: 100px repeat(10, 1fr); /* Day label + 10ì‹œê°„ */
    gap: 0;
    font-weight: 600;
    color: #333;
  }
  .week .header div {
    padding: .25rem .5rem;
    font-size: .9rem;
  }
  .week .header .label { color: #555; }

  /* ìš”ì¼ í–‰ */
  .day-row {
    display: grid;
    grid-template-columns: 100px 1fr; /* ë¼ë²¨ + ì‹œê°„ì˜ì—­ */
    align-items: stretch;
  }
  .day-row .label {
    padding: .5rem .5rem;
    border-top: 1px solid #eee;
    border-right: 1px solid #eee;
    font-weight: 600;
    color: #444;
    background: #fafafa;
  }
  .day-row .hours {
    position: relative;
    border-top: 1px solid #eee;
    min-height: 48px; /* ê¸°ë³¸ ë†’ì´ */
    /* 10ë¶„ ê°€ì´ë“œ: ì „ì²´ í­ì„ 60ë“±ë¶„(10ì‹œê°„ Ã— 6)í•˜ì—¬ ì–‡ì€ ì„¸ë¡œ ë¼ì¸ */
    background-image:
      /* 1ì‹œê°„ êµµì€ ë¼ì¸(10ë“±ë¶„) */
      linear-gradient(to right, rgba(0,0,0,.12) 0, rgba(0,0,0,.12) 1px, transparent 1px),
      /* 10ë¶„ ê°€ì´ë“œ(60ë“±ë¶„) */
      repeating-linear-gradient(to right,
        rgba(0,0,0,.08) 0 1px,
        transparent 1px calc(100%/60)
      );
    background-size:
      calc(100%/10) 100%, /* ì‹œê°„ ë¼ì¸ ê°„ê²© */
      100% 100%;          /* 10ë¶„ ê°€ì´ë“œ ì „ì²´ ì ìš© */
    background-position:
      left top,
      left top;
    background-repeat: repeat no-repeat;
  }
  /* ì‹œê°„ ë¨¸ë¦¬ê¸€(8~17ë¼ë²¨) ì•„ë˜ì˜ 1ì‹œê°„ ê²½ê³„ì„ ê³¼ ì–¼ë¼ì¸ì„ ë§ì¶”ê¸° ìœ„í•´ padding */
  .hours::before { content: ""; display: block; height: 0; }

  /* í¼ê³¼ í† íƒˆ íŒ¨ë„ */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr) auto;
    gap: .75rem;
    margin-top: 1rem;
  }
  .form-grid label { display: block; font-size: .85rem; color: #333; margin-bottom: .35rem; }
  .form-grid select, .form-grid button {
    width: 100%; padding: .5rem; border: 1px solid #ddd; border-radius: 8px; background: #fff;
    font-family: inherit;
  }
  .form-grid button { background: #002E5D; color: #fff; cursor: pointer; font-weight: 600; }

  .totals h3 { margin: 0 0 .5rem 0; font-size: 1rem; }
  .totals .list { display: grid; gap: .5rem; }
  .totals .row { display: flex; justify-content: space-between; font-size: .95rem; }
  .totals .weekly { margin-top: .75rem; padding-top: .75rem; border-top: 1px dashed #ddd; font-weight: 700; }

  /* ì‘ì€ í™”ë©´ ëŒ€ì‘ */
  @media (max-width: 900px) {
    .page { grid-template-columns: 1fr; }
  }

   /* ì„ íƒ ìŠ¬ë¡¯(10ë¶„ ë‹¨ìœ„) */
  .hours { position: relative; } /* ì´ë¯¸ ìˆìŒ: ì•ˆì „í•˜ê²Œ ìœ ì§€ */
  .hours .slot {
    position: absolute;
    top: 0; bottom: 0;
    background: #002E5D;
    /* ì‹œê°ì ìœ¼ë¡œ ê·¸ë¦¬ë“œ ìœ„ì— ì˜¬ë¼ì˜¤ë„ë¡ */
    z-index: 1;
    /* ì ‘ê·¼ì„± í–¥ìƒìš©(í¬ì»¤ìŠ¤ í…Œë‘ë¦¬ ë“± í•„ìš”ì‹œ) */
    outline: none;
  }

  #validation-banner {
  background: #fff0f0;
  color: #b00020;
  /* í•œ ì¤„ + íŒ¨ë”© ê¸°ì¤€ìœ¼ë¡œ ë†’ì´ ê³ ì • (ìƒí™©ì— ë§ê²Œ 40~48px ì¡°ì • ê°€ëŠ¥) */
  min-height: 44px;
  display: block;          /* í•­ìƒ ë¸”ë¡(ìë¦¬ ì°¨ì§€) */
  visibility: hidden;      /* ê¸°ë³¸ì€ ìˆ¨ê¹€(ìë¦¬ ìœ ì§€) */
  opacity: 0;              /* ê¸°ë³¸ì€ íˆ¬ëª… */
  transition: opacity 120ms ease-in;
  margin-bottom: 1rem;     /* ì•„ë˜ ì½˜í…ì¸ ì™€ ê°„ê²© ìœ ì§€ */
  white-space: normal;     
  overflow: hidden;
  text-overflow: ellipsis;
  overflow-wrap: anywhere;
}

/* ì—ëŸ¬ ìˆì„ ë•Œë§Œ ë³´ì´ê²Œ */
#validation-banner.show {
  visibility: visible;
  opacity: 1;
}

.day-row .hours.locked { pointer-events: none; cursor: not-allowed; }

#review-banner {
  background:#fdecec;
  color:#8a0000;
  display:none;
  margin-bottom:1rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#review-banner.show { display:block; }

/* Submit / Reset ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
#schedule-form button {
  font-family: "IBM Plex Sans", Helvetica, Arial, sans-serif;
  background: #002E5D;
  color: #fff;
  border: none;              /* í…Œë‘ë¦¬ ì œê±° */
  border-radius: 8px;        /* ëª¨ì„œë¦¬ ë¼ìš´ë“œ(ì›í•˜ë©´ ì¡°ì •) */
  padding: .55rem .9rem;
  font-weight: 700;
  cursor: pointer;
}

/* ìƒíƒœì— ë”°ë¥¸ ìƒí˜¸ì‘ìš© */
#schedule-form button:hover:not(:disabled) { opacity: .92; }
#schedule-form button:disabled { opacity: .5; cursor: not-allowed; }

/* ì ‘ê·¼ì„± í¬ì»¤ìŠ¤(ì„ íƒ ì‚¬í•­) */
#schedule-form button:focus-visible {
  outline: 2px solid #c9d7ea;
  outline-offset: 2px;
}



</style>

<div class="page">
  <!-- ì¢Œì¸¡: ìŠ¤ì¼€ì¤„ í¸ì§‘ ì˜ì—­ -->
  <section class="card">
    <div class="body">
      <div class="status-banner" id="status-banner" data-status="{{.Status}}">
        Status: {{if eq .Status "Pending"}}Pending Approval{{else}}{{.Status}}{{end}}
      </div>
      <div class="status-banner validation" id="validation-banner" aria-live="polite"></div>

      <div class="status-banner review {{if .RejectComment}}show{{end}}" id="review-banner" aria-live="polite">
        {{if .RejectComment}}Reason for Rejection: {{.RejectComment}}{{end}}
      </div>

      <script id="saved-schedule" type="application/json">{{.SavedJSON}}</script>



      <!-- ì‹œê°„ ê·¸ë¦¬ë“œ í—¤ë” -->
      <div class="week">
        <div class="header">
          <div class="label">Day</div>
          <div>8:00</div><div>9:00</div><div>10:00</div><div>11:00</div><div>12:00</div>
          <div>1:00</div><div>2:00</div><div>3:00</div><div>4:00</div><div>5:00</div>
        </div>

        <!-- ìš”ì¼ í–‰ë“¤: 10ë¶„ ê°€ì´ë“œëŠ” .hours ì˜ì—­ ë°°ê²½ìœ¼ë¡œ ì‹œê°í™” -->
        <div class="day-row">
          <div class="label">Mon</div>
          <div class="hours"></div>
        </div>
        <div class="day-row">
          <div class="label">Tue</div>
          <div class="hours"></div>
        </div>
        <div class="day-row">
          <div class="label">Wed</div>
          <div class="hours"></div>
        </div>
        <div class="day-row">
          <div class="label">Thu</div>
          <div class="hours"></div>
        </div>
        <div class="day-row">
          <div class="label">Fri</div>
          <div class="hours"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ìš°ì¸¡: í•©ê³„ íŒ¨ë„ -->
  <aside class="card totals">
    <div class="body">
      <h3>Totals</h3>
      <div class="list">
        <div class="row"><span>Mon</span><span>0h 0m</span></div>
        <div class="row"><span>Tue</span><span>0h 0m</span></div>
        <div class="row"><span>Wed</span><span>0h 0m</span></div>
        <div class="row"><span>Thu</span><span>0h 0m</span></div>
        <div class="row"><span>Fri</span><span>0h 0m</span></div>
      </div>
      <div class="weekly row"><span>Weekly Total</span><span>0h 0m</span></div>

      <!-- ì œì¶œ/ë¦¬ì…‹ ìë¦¬(V1ì—ì„  ë¹„í™œì„±) -->
      <form id="schedule-form" hx-post="/schedule/submit" hx-target="#status-banner" hx-swap="outerHTML">
        <input type="hidden" name="schedule_json" id="schedule-json" />
        <div style="margin-top:1rem; display:flex; gap:.5rem;">
          <button type="submit" id="btn-submit" disabled>Submit for Approval</button>
          <button type="button" id="btn-reset">Reset</button>
        </div>
      </form>

    </div>
  </aside>
</div>
<script>
(function () {
  // ----- ì„¤ì • -----
  const SLOTS_PER_DAY = 60;          // 8:00~18:00, 10ë¶„ ë‹¨ìœ„
  const DAY_START_MIN = 8 * 60;      // 8:00 = 480ë¶„
  const MIN_SHIFT_MIN = 3 * 60;      // ìµœì†Œ 3ì‹œê°„
  const MAX_DAILY_MIN = 9 * 60;      // í•˜ë£¨ ìµœëŒ€ 9ì‹œê°„
  const MIN_WEEKLY_MIN = 20 * 60;    // ì£¼ 20ì‹œê°„
  const MAX_WEEKLY_MIN = 40 * 60;    // ì£¼ 40ì‹œê°„

  let lastSubmittedJSON = null;   // ì„±ê³µ ì œì¶œëœ í˜ì´ë¡œë“œ ë¬¸ìì—´
  let lastValidationOK = false;   // ì§ì „ ê²€ì¦ ê²°ê³¼

  // --- í¸ì§‘ ì ê¸ˆ ìƒíƒœ ì œì–´ ---
  let editingLocked = false;
  function setLockedUI(lock) {
    editingLocked = lock;
    document.querySelectorAll('.day-row .hours')
      .forEach(el => el.classList.toggle('locked', lock));
  }
  function isApprovedStatus() {
    const banner = document.getElementById('status-banner');
    const v = (banner?.dataset?.status || banner?.textContent || '').toLowerCase();
    return v.includes('approved');
  }

  function readSavedSchedule() {
    const el = document.getElementById('saved-schedule');
    if (!el) return null;
    const txt = (el.textContent || '').trim();
    if (!txt) return null;
    try { return JSON.parse(txt); } catch { return null; }
  }

  // ===== ì„œë²„ ì €ì¥ë³¸ìœ¼ë¡œ ê·¸ë¦¬ë“œ ë³µì› =====
  function hhmmToMinutes(str) {
    const [h, m] = str.split(':').map(Number);
    return h * 60 + m;
  }
  function hydrateFromSaved(saved) {
    if (!saved || !saved.days) return;

    // ìš”ì¼ ë¼ë²¨ -> hours ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ë¹ ë¥´ê²Œ ì°¾ê¸°
    const dayMap = {};
    document.querySelectorAll('.day-row').forEach((row) => {
      const label = row.querySelector('.label')?.textContent?.trim();
      const hoursEl = row.querySelector('.hours');
      if (label && hoursEl) dayMap[label] = hoursEl;
    });

    // ê° ìš”ì¼ì˜ intervalì„ 10ë¶„ ìŠ¬ë¡¯ìœ¼ë¡œ í¼ì³ì„œ .slot ìƒì„±
    saved.days.forEach((d) => {
      const hoursEl = dayMap[d.day];
      if (!hoursEl || !Array.isArray(d.intervals)) return;

      d.intervals.forEach((seg) => {
        const sMin = hhmmToMinutes(seg.start);
        const eMin = hhmmToMinutes(seg.end);

        // 08:00(480) ê¸°ì¤€ 10ë¶„ ì¸ë±ìŠ¤ [sIdx, eIdx)
        let sIdx = Math.floor((sMin - DAY_START_MIN) / 10);
        let eIdx = Math.floor((eMin - DAY_START_MIN) / 10);

        // ë²”ìœ„ í´ë¨í”„
        if (sIdx < 0) sIdx = 0;
        if (sIdx > SLOTS_PER_DAY) sIdx = SLOTS_PER_DAY;
        if (eIdx < 0) eIdx = 0;
        if (eIdx > SLOTS_PER_DAY) eIdx = SLOTS_PER_DAY;

        for (let idx = sIdx; idx < eIdx; idx++) {
          // ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ
          if (hoursEl.querySelector(`.slot[data-slot="${idx}"]`)) continue;
          const slot = document.createElement('div');
          slot.className = 'slot';
          slot.dataset.slot = String(idx);
          const widthPct = 100 / SLOTS_PER_DAY;
          slot.style.left = (idx * widthPct) + '%';
          slot.style.width = widthPct + '%';
          hoursEl.appendChild(slot);
        }
      });
    });
  }

  // ---- ì„œë²„ ì €ì¥ë³¸ Hydrate (ëª¨ë“  ë°”ì¸ë”©/ìƒìˆ˜ ì´ˆê¸°í™” í›„) ----
  try {
    const saved = readSavedSchedule();
    if (saved) {
      hydrateFromSaved(saved);
      // ìƒíƒœì— ë”°ë¥¸ baseline ì„¤ì •:
      const status = (document.getElementById('status-banner')?.dataset?.status || '').toLowerCase();
      if (status.includes('approved') || status.includes('pending')) {
        lastSubmittedJSON = JSON.stringify(saved); // ìŠ¹ì¸/ëŒ€ê¸° ì¤‘ì¸ ì„œë²„ ì €ì¥ë³¸ì„ ê¸°ì¤€ì„ ìœ¼ë¡œ
      }
    }
  } catch (e) {
    console.error('hydrate failed:', e);
  }



  const DAY_ROWS = Array.from(document.querySelectorAll('.day-row')); // Mon~Fri
  const TOTAL_ROWS = Array.from(document.querySelectorAll('.totals .list .row'));
  const WEEKLY_TOTAL_SPAN = document.querySelector('.totals .weekly span:last-child');
  const VALID_BANNER = document.getElementById('validation-banner');
  const SUBMIT_BTN = document.getElementById('btn-submit');
  const RESET_BTN = document.getElementById('btn-reset');
  const FORM = document.getElementById('schedule-form');
  const JSON_INPUT = document.getElementById('schedule-json');

  // ----- ìœ í‹¸ -----
  const fmt = (min) => `${Math.floor(min / 60)}h ${min % 60}m`;
  const pad2 = (n) => (n < 10 ? '0' + n : '' + n);
  function indexToTime(idx) {
    const total = DAY_START_MIN + idx * 10;
    const h = Math.floor(total / 60);
    const m = total % 60;
    return `${pad2(h)}:${pad2(m)}`;
  }
  function getDayLabel(row) {
    const t = row.querySelector('.label')?.textContent?.trim() || '';
    return t; // 'Mon' ë“±
  }
  function getHoursEl(row) {
    return row.querySelector('.hours');
  }
  function getSelectedIndices(hoursEl) {
    return Array.from(hoursEl.querySelectorAll('.slot'))
      .map(el => parseInt(el.dataset.slot, 10))
      .filter(Number.isFinite)
      .sort((a,b)=>a-b);
  }
  // ì—°ì† ìŠ¬ë¡¯ì„ êµ¬ê°„ìœ¼ë¡œ ë³€í™˜
  function indicesToIntervals(indices) {
    const out = [];
    if (!indices.length) return out;
    let start = indices[0];
    let prev = indices[0];
    for (let i = 1; i < indices.length; i++) {
      const idx = indices[i];
      if (idx === prev + 1) {
        prev = idx;
        continue;
      }
      // [start, prev]ê¹Œì§€ê°€ í•œ êµ¬ê°„(ëì€ prev+1ë¡œ ì·¨ê¸‰)
      out.push([start, prev + 1]);
      start = idx;
      prev = idx;
    }
    out.push([start, prev + 1]);
    return out;
  }
  function intervalsToPayload(intervals) {
    // [{startIdx,endIdx}] -> [{start:"HH:MM", end:"HH:MM", minutes}]
    return intervals.map(([s, e]) => {
      const minutes = (e - s) * 10;
      return { start: indexToTime(s), end: indexToTime(e), minutes };
    });
  }

  // ----- í•©ê³„ -----
  function recalcTotals() {
    let weeklyMin = 0;
    DAY_ROWS.forEach((row, i) => {
      const hoursEl = getHoursEl(row);
      const mins = hoursEl.querySelectorAll('.slot').length * 10;
      weeklyMin += mins;
      const rightSpan = TOTAL_ROWS[i]?.querySelector('span:last-child');
      if (rightSpan) rightSpan.textContent = fmt(mins);
    });
    if (WEEKLY_TOTAL_SPAN) WEEKLY_TOTAL_SPAN.textContent = fmt(weeklyMin);
  }

  // ----- ìŠ¤ì¼€ì¤„ JSON ìƒì„± -----
  function buildSchedule() {
    let weeklyMin = 0;
    const days = DAY_ROWS.map((row) => {
      const day = getDayLabel(row);
      const hoursEl = getHoursEl(row);
      const indices = getSelectedIndices(hoursEl);
      const intervalsIdx = indicesToIntervals(indices);
      const intervals = intervalsToPayload(intervalsIdx);
      const totalMinutes = indices.length * 10;
      weeklyMin += totalMinutes;
      return { day, intervals, totalMinutes };
    });
    return { days, weeklyTotalMinutes: weeklyMin };
  }

  // ----- í”„ë¡ íŠ¸ ìœ íš¨ì„± ê²€ì‚¬ -----
  function validateSchedule(schedule) {
    const errors = [];

    let hasShortShift = false;     // 3ì‹œê°„ ë¯¸ë§Œ êµ¬ê°„ ì¡´ì¬ ì—¬ë¶€
    let hasOverDailyMax = false;   // í•˜ë£¨ ì´ 9ì‹œê°„ ì´ˆê³¼ ì¡´ì¬ ì—¬ë¶€

    for (const d of schedule.days) {
      // í•˜ë£¨ ì´ 9ì‹œê°„ ì´ˆê³¼?
      if (d.totalMinutes > MAX_DAILY_MIN) hasOverDailyMax = true;

      // êµ¬ê°„ 3ì‹œê°„ ë¯¸ë§Œ?
      if (!hasShortShift) {
        for (const seg of d.intervals) {
          if (seg.minutes > 0 && seg.minutes < MIN_SHIFT_MIN) {
            hasShortShift = true;
            break;
          }
        }
      }
    }

    if (hasShortShift) {
      errors.push('A shift should be more than 3 hours.');
    }
    if (hasOverDailyMax) {
      errors.push('A day\'s total working hours must not exceed 9 hours.');
    }

    // ì£¼ê°„ 20~40ì‹œê°„
    if (schedule.weeklyTotalMinutes < MIN_WEEKLY_MIN || schedule.weeklyTotalMinutes > MAX_WEEKLY_MIN) {
      errors.push(`Weekly Total: ${fmt(schedule.weeklyTotalMinutes)} (Required Hours: ${fmt(MIN_WEEKLY_MIN)} â€“ ${fmt(MAX_WEEKLY_MIN)})`);
    }

    return { ok: errors.length === 0, errors };
  }

  function showValidation(result) {
    lastValidationOK = result.ok; // ìƒíƒœ ë³´ê´€

    if (result.ok) {
      VALID_BANNER.textContent = '';
      VALID_BANNER.classList.remove('show');
    } else {
      VALID_BANNER.textContent = 'Validation: ' + result.errors.slice(0, 2).join(' | ');
      VALID_BANNER.classList.add('show');
    }
}

  function refreshValidationAndPayload() {
    recalcTotals();
  const schedule = buildSchedule();
  const scheduleJSON = JSON.stringify(schedule);
  JSON_INPUT.value = scheduleJSON;

  const result = validateSchedule(schedule);
  showValidation(result);

  // --- ì œì¶œ ê°€ëŠ¥ ì¡°ê±´ ê³„ì‚° ---
  const approved = isApprovedStatus();
  const dirty = (lastSubmittedJSON === null) ? (scheduleJSON !== 'null' && scheduleJSON !== '{"days":[],"weeklyTotalMinutes":0}')
                                            : (scheduleJSON !== lastSubmittedJSON);

  // ì¡°ê±´: â‘  ê²€ì¦ í†µê³¼ â‘¡ Approved ì•„ë‹˜ â‘¢ dirty í•´ì•¼ í•¨
  const canSubmit = result.ok && !approved && dirty;

  SUBMIT_BTN.disabled = !canSubmit;

  return result;
  }

  // ----- ìŠ¬ë¡¯ ê·¸ë¦¬ê¸°/ì§€ìš°ê¸°(ë“œë˜ê·¸ í† ê¸€) -----
  function createSlot(idx) {
    const slot = document.createElement('div');
    slot.className = 'slot';
    slot.dataset.slot = String(idx);
    const widthPct = 100 / SLOTS_PER_DAY;
    slot.style.left = (idx * widthPct) + '%';
    slot.style.width = widthPct + '%';
    return slot;
  }
  function indexFromEvent(ev, el) {
    const rect = el.getBoundingClientRect();
    const clientX = ev.touches ? ev.touches[0].clientX : ev.clientX;

    // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ x
    let x = clientX - rect.left;

    // ê²½ê³„ ë³´ì •: ì˜¤ë¥¸ìª½ ëì—ì„œ idx=60 ë°©ì§€
    if (x < 0) x = 0;
    if (x >= rect.width) x = rect.width - 0.0001;

    const ratio = x / rect.width;

    // 0 â‰¤ idx â‰¤ 59 ë¡œ í´ë¨í”„
    let idx = Math.floor(ratio * SLOTS_PER_DAY); // SLOTS_PER_DAY = 60
    if (idx < 0) idx = 0;
    if (idx >= SLOTS_PER_DAY) idx = SLOTS_PER_DAY - 1;

    return idx;
  }

  document.querySelectorAll('.day-row .hours').forEach((hoursEl) => {
    let isDragging = false;
    let dragMode = null; // 'paint' | 'erase'
    let lastIndex = null;
    let suppressNextClick = false;

    hoursEl.addEventListener('click', (ev) => {
      if (editingLocked) return;
      if (suppressNextClick) {
        ev.preventDefault();
        ev.stopImmediatePropagation();
        suppressNextClick = false;
        return;
      }
      if (isDragging) return;
      const idx = indexFromEvent(ev, hoursEl);
      const existing = hoursEl.querySelector(`.slot[data-slot="${idx}"]`);
      if (existing) existing.remove();
      else hoursEl.appendChild(createSlot(idx));
      refreshValidationAndPayload();
    }, true);

    const applyAtIndex = (idx) => {
      const existing = hoursEl.querySelector(`.slot[data-slot="${idx}"]`);
      if (dragMode === 'erase') {
        if (existing) existing.remove();
      } else {
        if (!existing) hoursEl.appendChild(createSlot(idx));
      }
    };

    const onStart = (ev) => {
      if (editingLocked) return;
      isDragging = true;
      dragMode = null;
      lastIndex = null;
      const idx = indexFromEvent(ev, hoursEl);
      const existing = hoursEl.querySelector(`.slot[data-slot="${idx}"]`);
      dragMode = existing ? 'erase' : 'paint';
      applyAtIndex(idx);
      lastIndex = idx;
      refreshValidationAndPayload();
    };

    const onMove = (ev) => {
      if (!isDragging) return;
      const idx = indexFromEvent(ev, hoursEl);
      if (idx === lastIndex) return;
      lastIndex = idx;
      applyAtIndex(idx);
      refreshValidationAndPayload();
    };

    const onEnd = () => {
      isDragging = false;
      dragMode = null;
      lastIndex = null;
      suppressNextClick = true; // ë“œë˜ê·¸ í›„ click 1íšŒ ë¬´ì‹œ
      refreshValidationAndPayload();
    };

    hoursEl.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onEnd);

    hoursEl.addEventListener('touchstart', onStart, { passive: true });
    window.addEventListener('touchmove', onMove, { passive: true });
    window.addEventListener('touchend', onEnd);
    window.addEventListener('touchcancel', onEnd);

    hoursEl.style.userSelect = 'none';
  });

  // ----- Reset ë²„íŠ¼ -----
  if (RESET_BTN) {
  RESET_BTN.addEventListener('click', () => {
    // ì „ë¶€ ì§€ìš°ê¸°
    document.querySelectorAll('.day-row .hours .slot').forEach(el => el.remove());

    // ğŸ”¹ ë°˜ë ¤ ì‚¬ìœ  ê°ì¶”ê¸°
    const rb = document.getElementById('review-banner');
    if (rb) { rb.textContent = ''; rb.classList.remove('show'); }

    // ğŸ”¹ ì ê¸ˆ í•´ì œ
    setLockedUI(false);

    // ğŸ”¹ ë°°ë„ˆë¥¼ Draft ìŠ¤íƒ€ì¼ë¡œ ë˜ëŒë¦¼(ë¡œì»¬ UI ê°±ì‹ )
    const banner = document.getElementById('status-banner');
    if (banner) {
      banner.textContent = 'Status: Draft';
      banner.dataset.status = 'Draft';
      banner.style.background = '#eef5ff';
      banner.style.color = '#002E5D';
    }

    // í•©ê³„/ê²€ì¦ ê°±ì‹ 
    lastSubmittedJSON = null;
    refreshValidationAndPayload();
  });
}


  // ----- Submit ì²˜ë¦¬ (í”„ë¡ íŠ¸ ê²€ì¦ â†’ í†µê³¼ ì‹œ HTMX ì œì¶œ) -----
  if (FORM) {
    FORM.addEventListener('submit', (e) => {
    const approved = isApprovedStatus();
    const result = refreshValidationAndPayload();
    if (approved || SUBMIT_BTN.disabled || !result.ok) {
      e.preventDefault();
      e.stopPropagation();
    }
  });
  }

  // ----- HTMX ì‘ë‹µ í›„ ìƒíƒœë°°ë„ˆ ê°±ì‹  (200ëŒ€ë©´ Pendingìœ¼ë¡œ í‘œì‹œ) -----
  document.body.addEventListener('htmx:afterRequest', (e) => {
    const xhr = e.detail && e.detail.xhr;
  if (xhr && xhr.status >= 200 && xhr.status < 300) {
    const banner = document.getElementById('status-banner');
    if (banner) {
      banner.textContent = 'Status: Pending Approval';
      banner.dataset.status = 'Pending';
    }

    // ì œì¶œ ì§í›„ ìŠ¤ëƒ…ìƒ· ê³ ì • â†’ ë³€ê²½ ì „ê¹Œì§€ ì¬ì œì¶œ ë¶ˆê°€
    const snap = buildSchedule();
    lastSubmittedJSON = JSON.stringify(snap);

    // ë°˜ë ¤ ë°°ë„ˆ ìˆ¨ê¹€
    const rb = document.getElementById('review-banner');
    if (rb) { rb.textContent = ''; rb.classList.remove('show'); }

    // Pendingì´ë©´ í¸ì§‘ì€ í—ˆìš© (ìš”êµ¬ì‚¬í•­)
    setLockedUI(false);

    // ë²„íŠ¼ ìƒíƒœ ì¬ê³„ì‚°
    refreshValidationAndPayload();
  }
  });

  // ---- ì„œë²„ ì €ì¥ë³¸ Hydrate (ëª¨ë“  ë°”ì¸ë”©/ìƒìˆ˜ ì´ˆê¸°í™” í›„) ----
  try {
    const saved = readSavedSchedule();
    if (saved) {
      hydrateFromSaved(saved);
    }
  } catch (e) {
    console.error('hydrate failed:', e);
  }

  // ì„œë²„ ìƒíƒœê°€ Approvedë©´ í¸ì§‘ ì ê¸ˆ
  setLockedUI(isApprovedStatus());


  // ì´ˆê¸° í‘œì‹œ
  refreshValidationAndPayload();

})();
</script>


{{end}}

{{define "schedule"}}{{template "base" .}}{{end}}